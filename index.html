<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma 3 リアルチャット (PyScript + OpenRouter API)</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2024.1.1/pyscript.js"></script>

    <py-config>
        packages = ["requests"] 
    </py-config>

    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #880e4f; border-bottom: 2px solid #880e4f; padding-bottom: 10px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; min-height: 100px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #880e4f; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #5d0033; }
        .response-box { border: 1px solid #ddd; padding: 15px; border-radius: 4px; background-color: #fff3e0; white-space: pre-wrap; margin-top: 15px; }
        .error { color: red; font-weight: bold; }
        .loading { color: #880e4f; }
        .usage { font-size: 0.8em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚛️ OpenRouter API (Gemma 3) Chat</h1>
        <p><strong>モデル:</strong> google/gemma-3-27b-it:free (OpenRouter経由)</p>
        <p>早稲田中学校 物理研究部 レゴプログラミング班の質問に答えます！</p>
        
        <label for="prompt_input">質問を入力してください:</label>
        <textarea id="prompt_input" placeholder="例: レゴSPIKEプライムで効率的なギア比を計算するには？"></textarea>
        
        <button id="run_button" py-onClick="run_chat()">Gemma 3 に聞く</button>
        
        <h2>回答:</h2>
        <div id="api_response_output" class="response-box">
            ここにGemma 3 の回答が表示されます。
        </div>

        <py-script>
import json
# requestsを非同期で使用します
import requests 
from pyscript import Element

# ⚠️ 注意: APIキーを直接コード内に記述することは非推奨です。
# ご自身のキーに置き換えてください。
# 以前使用されていたキーをそのまま記載していますが、必ず確認・変更してください。
OPENROUTER_API_KEY = "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" 
OPENROUTER_BASE_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL_NAME = "google/gemma-3-27b-it:free"

# run_chat 関数を async に変更し、非同期通信に対応させます
async def run_chat(): 
    """
    ボタンクリック時に実行される関数。APIを非同期で呼び出します。
    """
    output_element = Element('api_response_output')
    
    # 1. 入力値の取得とチェック
    user_prompt = Element('prompt_input').value
    if not user_prompt.strip():
        output_element.write("質問を入力してください。", append=False)
        return

    # 2. ロード中メッセージの表示
    output_element.write('<span class="loading">... Gemma 3 が思考中です ...</span>', append=False)
    
    # 3. リクエストヘッダーとペイロードの構築
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json",
        # OpenRouterはユーザー識別子を推奨
        "HTTP-Referer": "https://example.com/pyscript-chat-demo" 
    }

    data = {
        "model": MODEL_NAME,
        "messages": [
            {"role": "user", "content": user_prompt}
        ],
        "max_tokens": 500,
        "temperature": 0.7
    }

    # 4. API呼び出し (await requests.postを使用)
    try:
        # requests.post() の前に await を追加して非同期実行を待機
        response = await requests.post( 
            OPENROUTER_BASE_URL, 
            headers=headers, 
            data=json.dumps(data)
        )
        response.raise_for_status() # HTTPエラーがあれば例外を発生させる

        # 5. 応答の解析
        json_response = response.json()
        
        if json_response.get('choices'):
            model_response = json_response['choices'][0]['message']['content'].strip()
            total_tokens = json_response['usage']['total_tokens'] if json_response.get('usage') else "N/A"
            
            # 6. 結果の表示
            html_output = f"""
            <p><strong>【Gemma 3 の応答】</strong></p>
            {model_response}
            <div class="usage">
                --- 使用情報 ---<br>
                総トークン数: {total_tokens}
            </div>
            """
            output_element.write(html_output, append=False)
            
        else:
            # APIがエラーコードなしに無効なJSONを返した場合の処理
            error_message = f"【エラー】APIからの応答が不完全です。JSON: {json.dumps(json_response, indent=2)}"
            output_element.write(f'<div class="error">{error_message}</div>', append=False)


    except requests.exceptions.RequestException as e:
        # HTTPエラーコード (4xx, 5xx) やネットワークエラーの捕捉
        error_message = f"【API通信エラーが発生しました】<br>エラー内容: {e}"
        output_element.write(f'<div class="error">{error_message}</div>', append=False)
        
    except json.JSONDecodeError:
        error_message = "【応答エラー】APIから有効なJSONが返されませんでした。"
        output_element.write(f'<div class="error">{error_message}</div>', append=False)
    except Exception as e:
        error_message = f"【予期せぬエラー】: {e}"
        output_element.write(f'<div class="error">{error_message}</div>', append=False)
        
        </py-script>
    </div>
</body>
</html>
